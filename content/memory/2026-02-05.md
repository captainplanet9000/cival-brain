# 2026-02-05 Daily Log

## 20:45 PST - Heartbeat Check
- Dashboard health check timed out
- Found server on port 9005 (PID 74268) but unresponsive
- Restarted dashboard, came back online
- Server crashed again during service restoration attempts
- Restarted again (session keen-cove)
- Dashboard now healthy with auto-bootstrap running

Note: The old service endpoints in HEARTBEAT.md (meme-agents/scheduler, flash-loans/auto-execute, farms/learning-scheduler) may be deprecated. The current dashboard uses auto-bootstrap via instrumentation.ts to start services automatically on server start.

## 21:08 PST - Memory Crash Fix
Dashboard crashed 3x in 10 min from memory pressure. Investigated and fixed.

**Root Cause:** Aggressive batch startup (5 agents at once) causing memory spikes faster than GC recovery.

**Changes made:**
1. `agent-execution-loop.ts` - Reduced batch settings:
   - BATCH_SIZE: 5 → 2
   - BATCH_DELAY_MS: 90s → 120s  
   - INTRA_BATCH_DELAY_MS: 15s → 30s
   - Added GC hint between batches

2. `auto-bootstrap.ts` - Synced batch settings (was using different values)
   
3. `package.json` - Added `--expose-gc` flag to dev script

**Result:** 30 agents now bootstrap over ~30 min (was ~6 min). Much more stable.

**Files modified:**
- C:\TradingFarm\Cival-Dashboard-v9\src\lib\agents\agent-execution-loop.ts
- C:\TradingFarm\Cival-Dashboard-v9\src\lib\agents\auto-bootstrap.ts
- C:\TradingFarm\Cival-Dashboard-v9\package.json

## 21:32 PST - Comprehensive Memory Leak Fix
Anthony asked for a comprehensive fix. Investigation revealed:

**Root Causes:**
1. **18 separate Supabase clients** - each `createClient()` creates connection pools
2. **33 dynamic imports per agent cycle** - `await import()` inside runCycle, called every 15 min per agent

**Solution:**
1. Created `src/lib/supabase-singleton.ts` - single shared client
2. Converted all 33 dynamic imports to static imports at module level
3. Updated `position-monitor.ts`, `auto-bootstrap.ts`, `auto-rebalance-service.ts` to use singleton
4. Removed non-existent function calls (alertTradeEntry, alertTradeExit, notifyTradeExecuted)

**Results:**
- Before: 450MB → 1.9GB in ~2 min → crash
- After: 448MB → 464MB after 90s, stable

Dashboard now running with full auto-bootstrap enabled.

## 21:55 PST - PM2 Auto-Restart & Additional Fixes
Memory still climbing despite initial fixes. Found 62 total Supabase client leaks and fixed 48 more.

**Root issue:** 30 agents × 15 min cycles = too much memory pressure for dev mode.

**Solution:** Added PM2 with auto-restart at 1.5GB:
- Created `ecosystem.config.js` for PM2 configuration
- Dashboard auto-restarts gracefully instead of crashing
- Tunnel stays connected through restarts

Files:
- C:\TradingFarm\Cival-Dashboard-v9\ecosystem.config.js (new)
- All lib/*.ts files updated to use supabase-singleton
