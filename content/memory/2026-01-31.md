# 2026-01-31 Session Notes

## Cival Dashboard Work (C:\TradingFarm\Cival-Dashboard-v9)

### Key URLs
- Dashboard agents page: `http://localhost:9005/dashboard/agents` (NOT `/agents`)
- `/agents` page was deleted — it was an old unused page using `FunctionalAgentsTab`
- Dev server runs on port 9005, started with `npm run dev` from the project dir

### Capital & Allocation
- Account balance: $704.46 on Hyperliquid mainnet
- Wallet: 0xAe93892da6055a6ed3d5AAa53A05Ce54ee28dDa2
- 4 agents allocated by risk tolerance weight:
  - Elliot Wave Trader (aggressive 2.0): $247.17
  - Darvas Agent Alpha (moderate 1.5): $185.38
  - Williams Agent Beta (moderate 1.2): $148.30
  - Multi-Strat Agent Gamma (conservative 1.0): $123.58
- Total allocated: $704.43

### TRUMP Trade
- Multi-Strat Gamma closed TRUMP sell at +$67.17 net profit
- Trade ID: 962e95f0-4cd4-4404-8515-908e34b97e7e
- Had to manually fix trade status from "executed" to "closed" — position monitor kept re-detecting and inflating PnL to $45K

### Goals System Changes
1. **Goal-aware position closing** added to `position-monitor.ts`
   - `checkGoalCompletionClose()` — checks if unrealized PnL would complete any active profit goal
   - If yes, closes position via market order to lock in goal completion
   - Only triggers on unrealized > $5, only for active profit goals

2. **Goals on agent cards** added to `/dashboard/agents` page (`page.tsx`)
   - Fetches from `GET /api/agents/goals` (new endpoint)
   - Shows goals with progress bars on each agent card
   - Distinguishes GLOBAL vs agent-assigned goals
   - Auto-refreshes every 30s

3. **New API endpoints:**
   - `GET /api/agents/goals` — all goals grouped by agent
   - `GET /api/agents/[id]/goals` — per-agent goals
   - `POST /api/agents/[id]/goals` — assign goal to agent

### Rate Limiting Fixes
- Hyperliquid 429 errors were blocking all agent cycles
- **Request dedup** added to `shared-wallet-manager.ts` — concurrent callers share one inflight promise
- **Staggered bootstrap** — agents start 5s apart instead of all at once
- **Empty state fallback** — if no cache and API returns 429, returns empty state instead of throwing (cycles proceed with reduced functionality)
- Removed direct HL API fallback from `/api/agents/positions` — now only uses shared cache

### Goal Progress After Refresh
- $10 Profit Target: ✅ COMPLETED ($20.50)
- $25 Profit Target: ✅ COMPLETED ($66.81)
- $50 Profit Targets (x2): ✅ COMPLETED ($66.81)
- Monthly $100 Target: 66.8% ($66.81/$100)
- Win Rate Goal: 37% (16.67/45)

### Bug: onTradeClosed Double-Counting
- `goal-profit-collector.ts` `onTradeClosed` is called from BOTH position-monitor AND execution-loop
- If a trade stays in "executed" status, position monitor keeps re-closing it each cycle
- Each re-close adds profit to agent's total_pnl, inflating balance
- Fix: ensure trades transition to "closed" status properly
- May need dedup logic in onTradeClosed to check if already processed

### Windows PowerShell Notes
- `&&` doesn't work in PowerShell — use separate commands or `;`
- `curl` in PowerShell is aliased to `Invoke-WebRequest` — use `curl.exe` for real curl
- JSON with double quotes in curl needs escaping — easier to use node scripts
