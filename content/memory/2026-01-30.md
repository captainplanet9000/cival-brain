# 2026-01-30 — Major Cival Systems Trading Platform Overhaul

## Anthony's Project: Cival Systems
- Autonomous agent trading platform at C:\TradingFarm\Cival-Dashboard-v9
- Next.js dashboard on port 9005, Supabase backend, Hyperliquid mainnet trading
- Wallet: 0xAe93892da6055a6ed3d5AAa53A05Ce54ee28dDa2 ($230 account value)
- 4 agents: Darvas Alpha, Williams Beta, Multi-Strat Gamma, Elliott Wave
- 4 farms corresponding to each agent
- PM2 manages the dev server (ecosystem.config.cjs) for persistence

## Critical Fixes Implemented Today

### 1. Position Monitor (NEW)
- `src/lib/agents/position-monitor.ts` — polls Hyperliquid every 30s
- Detects when SL/TP fires (position disappears), marks trades closed in DB
- Calculates realized PnL, updates agent balances

### 2. Market Regime Detector (NEW)
- `src/lib/trading/market-regime-detector.ts` — 7 signal categories, 3 timeframes
- 10 regimes from strong_uptrend → capitulation
- BTC as market leader, confidence adjustment for counter-trend trades
- Currently detecting downtrend across most assets

### 3. Emergency Stop Fixed
- Was completely broken — agents auto-restarted on every dashboard poll via `autoStartActiveAgents()`
- Added `_emergencyStopped` flag to AgentExecutionManager singleton
- Removed auto-start from control route GET handler
- useEmergencyStop hook was a no-op stub — now actually calls API

### 4. Limit Orders
- Added `placeAggressiveLimitOrder()` to hyperliquid-connector.ts
- Uses ALO (Add Liquidity Only) for guaranteed maker rate (0.01% vs 0.042% taker)
- Saves ~$600/month in fees based on historical volume

### 5. Strategy Improvements
- Darvas: lookback 20→50, volume 1.3x→2x, RSI/ATR filters
- Multi-Strategy: downtrend bias fix (no bull credit for RSI<45 in downtrend)
- Elliott Wave: minimum 2% wave size, low-volume confidence penalty

### 6. Time-of-Day Filter
- Trading hour multipliers based on 2000-fill historical analysis
- Hours 3,8,13,14,19-22 UTC get 0.6x confidence penalty

### 7. Capital Allocation Fix
- Agents now know they share $230 wallet (was each thinking $97)
- Fair share = walletValue / activeAgentCount

### 8. Regime Enforcement
- Downtrend + BUY needs >85 confidence
- Capitulation/stay_out blocks ALL trades

### 9. Duplicate Position Prevention
- Gate 3b: checks if ANY other agent has open trade for same coin
- Position attribution: only most recent agent shown as owner

### 10. Per-Agent Thoughts
- `/api/agents/thoughts?per_agent=true` — 50 thoughts per agent, balanced

## Trade History Analysis (from Hyperliquid)
- 2000 fills over 80 days, $2M volume
- Gross PnL: +$807, Fees: -$865, Net: -$57
- Win rate 32% but 2.7x R:R (positive EV before fees)
- BTC (+$71), ETH (+$31), ENA (+$38) profitable
- SOL (-$50), SUI (-$59), TRUMP (-$43) losing money
- Anthony wants to keep ALL coins (believes they'll turn around)

## Goals (updated)
- Monthly profit target: $100 (was unrealistic $50K)
- Win rate target: 45% (was 75%)
- Drawdown: 5% (kept)
- $10/$25/$50 goals activated

## In Progress
- Sub-agent building Goals tab, Vault tab, DeFi Lending tab (Aave V3 on Arbitrum)
- Cross-tab data flow: trades→goals, trades→vault, vault→aave

## Anthony's Preferences
- Wants everything REAL — mainnet, real money
- Keep all coins trading (even losing ones)
- 15-min trade interval is fine for now
- Inline styles on dashboard (no component libraries)
- Dev server on port 9005
- Rapid iteration, just get it done
