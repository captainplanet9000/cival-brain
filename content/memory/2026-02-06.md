# 2026-02-06 — Position Protection System Build

## Major Work: SL/TP Protection for Live Positions

### The Problem
- 3 live positions on Hyperliquid mainnet with ZERO stop losses or take profits:
  - BTC long 0.00213 @ $70,372 (16x cross leverage)
  - ETH long 0.0729 @ $2,058.53 (19x isolated)
  - SOL long 0.57 @ $87.085 (17x isolated)
- Execution bridge was NOT running
- `StopLossManager.ts` had TODO stubs — never placed orders
- `real-execution-bridge.ts` ignored `stop_loss`/`take_profit` from intent payloads

### Root Cause Found
- Position Monitor (`src/services/position-monitor.ts`) was **failing silently**
- It detected unprotected positions but couldn't place trigger orders
- The raw L1 signing code (msgpack + EIP-712 phantom agent) derived **wrong wallet addresses**
- PM2 logs showed `"User or API Wallet 0x... does not exist"` with random addresses each time

### Fix Applied
- Replaced raw L1 signing in position-monitor.ts `placeTriggerOrder` with official Hyperliquid SDK approach
- The SDK approach already works in `src/lib/hyperliquid/connection.ts` — matched that pattern
- Updated `syncAllPositions` to use `frontendOpenOrders` endpoint for reliable trigger order detection
- Confirmed `instrumentation.ts` auto-starts both execution bridge (15s delay) and position monitor (30s delay)

### Architecture Discovered
Extensive existing infrastructure catalogued across 100+ files:
- Position Alert Service, Portfolio Risk Engine, Safety Rails, Production Risk Manager
- Risk Management Engine, Emergency API, Agent Emergency Stop, Position Monitor
- Agent Exchange Bridge, Hyperliquid Connection
- Most were alerting/limiting only — NOT order-placing

### Key Technical Details
- Trigger order format: `t: { trigger: { triggerPx, isMarket: true, tpsl: 'sl'|'tp' } }` with `r: true` (reduce_only)
- Coin indices: BTC=0, ETH=1, SOL=5; szDecimals: BTC=5, ETH=4, SOL=2
- Default SL: 3% from entry, Default TP: 5% from entry
- Position monitor polls every 30s, self-heals if trigger orders get cancelled
- Branch: `feature/position-protection`

### Sub-Agent Spawned
- Building execution bridge SL/TP integration, API routes, and immediate fix for existing positions
- Still needs verification that SDK-based fix actually places trigger orders

### Account Status
- Hyperliquid account value: ~$1,251
- Total notional: ~$350
- 30 agents across 6 farms active but producing 0 decisions/0 orders
- API wallet "Bossman" (0x45a9...6B8) authorized for trading
- Main wallet: 0xAe93...dDa2

### Orchestrator Pipeline Fix (same session)
**Root cause**: Orchestrator was NEVER running since inception
1. `autonomous-trading-loop.ts` had recursive `getSupabase()` shadow → infinite recursion → crash on start
2. Module-level `let` state → doesn't survive Turbopack HMR — fixed with `globalThis`
3. Remote Supabase (`.env.local`) uses different schema than local: `name` not `farm_name`, `is_active` not `status`
4. `farms` table had 0 rows in local DB (was using remote DB all along)
5. `processApprovedTrades()` in the loop was COMPETING with execution bridge — removed to prevent double-execution
6. Added orchestrator auto-start to `instrumentation.ts` (was missing)

**After fix**: All 6 farms orchestrating successfully every 60s
- Elliott Wave, Heikin Ashi, Renko, Darvas Box, Williams Alligator, Multi-Strategy
- LLM calls working (OpenRouter → Gemini Flash)
- Cycle 1: 15s, all farms reporting bearish/hold
- Position monitor confirms all 3 positions still protected (SL+TP)

### Next Steps (carry forward)
1. ~~Verify SDK-based fix places SL/TP trigger orders~~ ✅ All 3 positions have SL+TP on Hyperliquid
2. ~~Confirm trigger orders appear on Hyperliquid~~ ✅ 6 orders confirmed
3. ~~Restart dashboard via PM2, confirm auto-start~~ ✅ All 3 services auto-start
4. Bridge status endpoint reports `running: false` despite actually running — minor bug
5. P1: Add trades table writes to bridge
6. P1: Order deduplication in monitor
7. Clean up git state (massive untracked files)

### First Live Trades Milestone
- **2026-02-06: FIRST LIVE TRADES** — BTC, ETH, SOL positions opened on Hyperliquid mainnet via Cival Dashboard
- This is a historic milestone for Cival Systems

---

## Evening Session: Full Protection System Integration

### 8 Protection Systems Integrated (all on `feature/position-protection` branch)
Built across 18+ commits, 57 files changed, ~5,500 lines:

1. **Portfolio Risk Engine** → execution bridge pre-trade veto (5% daily drawdown circuit breaker, per-coin limits)
2. **Agent Risk Manager** → position monitor uses ATR-based dynamic SL/TP (2x ATR stop, 3x ATR take profit, clamped 1-10% SL, 2-15% TP)
3. **Correlation Manager** → pre-trade check (BTC/ETH=0.85, SOL=0.80 correlation, warns on >40% same-direction)
4. **Position Scaler** → scale out at 25/50/75% of TP distance (partial close via reduce_only)
5. **Execution Audit** → full order lifecycle logging with slippage tracking in basis points
6. **Position Alert Service** → Telegram alerts at 25/50/75/100/150/200% ROE, liquidation warnings
7. **Profit Securing Service** → real Hyperliquid partial closes when profit rules trigger (was mock data, now real)
8. **Smart Entry** → limit orders at S/R levels with market fallback (opt-in via `ENABLE_SMART_ENTRY=true` env var)

### Farms + Goals Connected for 24/7 Autonomous
- **Macro context** (USDT.D, BTC dominance, Fear & Greed) feeds into every LLM prompt
- **Chop filter** (ADX + Choppiness Index) tells agents to STAY OUT of choppy markets
- **Manipulation detector** (whale wicks, volume anomalies) warns on suspicious activity
- **Goal progress tracker** runs every 5 minutes
- **Learning engine** cycles every ~10 minutes (pattern recognition, time-of-day analysis)
- Orchestrator now writes to `agent_thoughts` table so dashboard agent cards show fresh decisions

### Rebalancing Fixed: Only 6 Orchestrator Agents
- `auto-rebalance-service.ts` queries `farms.orchestration_agent_id` → only rebalances 6 farm leads
- `capital-allocator.ts` switched from `createClient` to `getSupabase()` singleton
- `/api/agents/control` GET reports only 6 orchestrator agents
- `/api/agents/rebalance` route filters to orchestrator agents only
- Dashboard agents page fetches farms to properly identify orchestrators
- All confirmed: 6 farms have valid `orchestration_agent_id` values

### Position Limits Updated
- `maxPositionUsd`: 50 → dynamic (min of availableMargin * 30%, 150)
- `maxDailyLoss`: 25 → 75 (~6% of account)
- `maxOpenPositions`: 3 → 12 (high-frequency support)
- `minPositionUsd`: 5 (skip micro trades)

### High-Frequency Margin-Aware Trading
Anthony opened manual SUI position (10,000 SUI @ $1.01, 10x, $1,003 margin = 80% of account).
Agents were blocked (risk score 100). Anthony's directive: agents should trade with AVAILABLE margin.

**Changes made:**
- Bridge fetches `withdrawable` from Hyperliquid each cycle — actual free margin
- Dynamic sizing: 15-30% of available margin per trade
- Portfolio risk engine: when `availableMargin` is provided, does NOT block on total exposure %
- Only blocks if specific trade exceeds 50% of available margin
- Manual positions don't inflate agent risk checks
- LLM prompt updated: "Target $0.25-$5 profit per trade, high-frequency"
- Circuit breaker (daily drawdown) always respected regardless

### Dashboard Bug Fixed
- Farms API (`/api/farms`) wasn't returning `orchestration_agent_id` or `is_active` → agent cards disappeared
- `showOrchestratorOnly` filter used broken `agent_type === 'orchestrator'` check
- Fixed: farms API now includes those fields, filter falls back to showing all agents if orchestrator IDs unavailable

### Key Decisions Made
- Keep Gemini 2.5 Flash for LLM (not DeepSeek) — speed/cost wins for 60s cycles
- Smart Entry defaults to OFF (`ENABLE_SMART_ENTRY=true` to enable) — safer for mainnet
- Agents trade with whatever margin is available, don't fight manual positions
- SL/TP clamped to 1-10% SL, 2-15% TP to prevent extreme ATR values
- All integrations non-blocking (try/catch everywhere)

### Account Status (end of evening)
- Account value: $1,251
- Margin used: $1,029 (SUI manual position dominates)
- Available margin: ~$222
- 4 positions: BTC, ETH, SOL (agent-opened) + SUI (manual)
- All 4 have SL/TP trigger orders on Hyperliquid
- 136+ orchestrator cycles completed
- 0 agent-initiated trades yet (was blocked by risk engine, now fixed)

### Git State — FINAL
- Branch: `feature/position-protection` — **20+ commits, ALL source files committed, working tree CLEAN**
- Comprehensive `.gitignore` added: excludes ~1,965 artifact files
- All 1,800+ untracked source files committed (590,788 insertions in commit `9c23769`)
- **NOT pushed yet** — Anthony needs to review and merge
- Key commits: `326dc51` (position protection), `4d8ced4` (orchestrator fix), `bf46a22` (trades writes + dedup), `2974b23`-`e709df0` (6 protection phases), `1f6437d` (profit securing + smart entry), `af3be7c` (farms+goals), `dfe8a22` (orchestrator-only rebalance), `97b24d0` (rebalance UI + position limits), `0c4f6c7` (agent_thoughts), `e67cfc8` (margin-aware trading), `1b25aaf` (.gitignore), `a9b8944` (scheduler/stub/flash-loan fixes), `9c23769` (all source files committed)

### Cloudflare Tunnel
- Ephemeral tunnel for mobile access: `cloudflared tunnel --url http://localhost:9005`
- Must use `Start-Process` to detach (exec sessions kill child processes)
- Tunnels die frequently — use detached process approach

---

## Late Night: Farm Detail Page UI Fix (In Progress)

### Problem
Anthony reported: Renko Breakout Farm's "Run Orchestration" button shows "cycle completed" but no output. Individual agent buttons (Run Analyst, Run Strategist, Run Risk Check, Run Execute) do nothing visible.

### Investigation
- Farm detail page at `src/app/dashboard/farms/[id]/page.tsx` (~1361 lines)
- `runFullCycle()` POSTs to `/api/farms/${farmId}/orchestrate`, parses `data.actions_taken` for logs
- `runSingleAgent(role)` POSTs `{ target_role: role }` to same orchestrate endpoint
- Agent output extracted via `getLatestAgentOutput(role)` which filters decisions where `d.result?._agent_role === role`
- Rich panel components: AnalystPanel, StrategistPanel, RiskManagerPanel, ExecutorPanel, USDTDominancePanel, OrchestratorPanel
- **Root cause likely**: API route `/api/farms/[id]/orchestrate/route.ts` may not return proper `actions_taken`, or agents don't store results with `_agent_role` in decision's `result` field → panels show "No analysis yet"
- **Next step**: Inspect the orchestrate API route to confirm what it returns and how `target_role` is handled

### Blocked Items (carry forward)
- Profit distribution + goal-profit collector use client-side Supabase (`@/lib/supabase/client`, `localStorage`) — cannot run server-side without import refactor. Left for separate PR.

### Remaining TODO
1. ~~Fix Farm detail page orchestration UI~~ ✅ DONE (commit `5736a32`)
2. Push `feature/position-protection` branch
3. Review and merge into main
4. Monitor system overnight
5. Refactor profit distribution for server-side
6. Enable Smart Entry when ready
7. Merge/close stale branches (6 unmerged)
8. Trailing stops implementation

---

## Late Night Session 2: Farm Detail Page Fix + Tamagotchi

### Farm Detail Page — ALL Tabs Fixed (commit `5736a32`)

**Root cause discovered:** Remote `agent_decisions` table was missing `farm_id`, `result` (JSONB), and `content` columns. The orchestrate API was inserting with those column names but they were silently dropped by Supabase → decisions tab showed "No content", agent panels showed "No analysis yet".

**DB Migration (direct SQL via pg):**
- Added `farm_id TEXT`, `result JSONB DEFAULT '{}'`, `content TEXT` to remote `agent_decisions`
- Added index on `farm_id`

**API Route Fixes:**
- `decisions/route.ts` — Rewrote: server-side supabase, queries by farm_id OR orchestrator agent_id, falls back to `agent_thoughts` table, maps `_agent_role` properly
- `agents/route.ts` — Switched from client-side `@/lib/supabase/client` import to server-side `createClient` with service role key
- `[id]/route.ts` — Same server-side fix, added `strategy`/`config`/`total_capital_usdc` to response
- `orchestrate/route.ts` — `saveAgentDecision` now sets `content` field; orchestrator summary also sets `content`
- `tasks/route.ts` — Created from scratch (endpoint was completely missing!)

**Stub Modules Created (fixed compile errors):**
- `src/lib/trading/market-regime-detector.ts` — stub for `detectMarketRegime()`
- `src/lib/trading/trailing-tp.ts` — stub for trailing take-profit logic

**Page Fix:**
- Farm detail page now reads `d.content || d.reasoning` for both Decisions tab and Overview activity

**Result:** Renko farm showed 40+ decisions with full agent role data, all panels populated.

### Tamagotchi Dog Character System (commit `55a4125`)

Anthony provided a custom 4×4 sprite sheet of a brown pixel-art dog with 16 mood frames. Built complete animation system:

**Sprite sheet:** `/public/sprites/multi-strat-dog.jpg` (4×4 grid)
- Row 0: Excited, Happy×3 (animated)
- Row 1: Confident, Neutral×2 (animated), Drowsy
- Row 2: Worried, Stressed, Trading (coins), Analyzing (glitch)
- Row 3: Sleeping×2 (animated), Dead×2 (ghost)

**11 Moods with state derivation:**
- excited (PnL>$50 or WR>70%), happy (PnL>$20), confident (PnL>$0), neutral (default), drowsy (5min idle), worried (PnL<-$10), stressed (PnL<-$30), trading (executing), analyzing (running analysis), sleeping (paused/10min idle), dead (stopped/wiped)

**Animation features:**
- Multi-frame sprite cycling (happy 3-frame, neutral 2-frame, sleeping 2-frame, dead 2-frame)
- CSS effects: bounce (excited), shake (worried), glitch (stressed/analyzing)
- Particle effects: hearts+stars, coins rain, sweat drops, Zzz, ghost
- LCD screen housing with pixel grid overlay
- Hover tooltip with PnL/win rate stats
- Mood indicator dot with glow

**Files:** `src/components/agents/AgentTamagotchi.tsx` (complete rewrite, 533 lines), sprite sheet in public/sprites/

### Key Lessons Learned
- Remote Supabase silently drops columns that don't exist (no error on insert!) — always verify schema matches code
- `@/lib/supabase/client` exports `supabase` (browser singleton), NOT `createClient` — for API routes use `createClient` from `@supabase/supabase-js` directly with service role key
- `.gitignore` had `public` excluded — need `git add -f` to force-add public assets
- `.next` cache can hold stale webpack state — delete `.next` folder + PM2 restart for clean compile
- `farm_tasks` table exists on remote but was missing an API endpoint — always check if routes exist for frontend fetches

### Git State
- Branch: `feature/position-protection` — 23+ commits, clean working tree, NOT pushed
- Latest commits: `5736a32` (farm detail fix), `55a4125` (tamagotchi dog)
- Sub-agent also made commit `90d47b3` (overlapping farm detail work, superseded by main session fix)
